<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Special Note</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font: Syne (Judul Unik) & Outfit (Bulat Modern) -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Icon (Phosphor Icons) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfigurasi Firebase & Global Variables
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}'); // Fallback kosong jika offline dev
        const appId = window.__app_id || 'default-app';
        
        let db, auth, currentUser;

        // Inisialisasi Firebase
        if (firebaseConfig.apiKey) {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            initAuth();
        } else {
            console.warn("Firebase config not found. Mode offline/demo.");
        }

        async function initAuth() {
            try {
                if (window.__initial_auth_token) {
                    await signInWithCustomToken(auth, window.__initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
            }
        }

        // Listener Auth
        if (auth) {
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    checkForCardId();
                }
            });
        }

        // --- FUNGSI LOGIKA APP ---

        // 1. Cek apakah ada ID di URL (Mode Melihat Pesan Teman)
        async function checkForCardId() {
            const urlParams = new URLSearchParams(window.location.search);
            const cardId = urlParams.get('id');

            if (cardId) {
                // Tampilkan Loading
                document.getElementById('loadingOverlay').classList.remove('hidden');
                
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'cards', cardId);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        updateUI(data);
                        // Matikan mode edit, sembunyikan tombol edit
                        document.getElementById('editBtnContainer').classList.add('hidden');
                    } else {
                        alert("Pesan tidak ditemukan! Mungkin linknya salah.");
                    }
                } catch (e) {
                    console.error("Error fetching card:", e);
                } finally {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }
            }
        }

        // 2. Simpan Data Baru (Mode Buat Pesan)
        window.saveCardToCloud = async function() {
            if (!currentUser || !db) {
                alert("Sedang menghubungkan ke server... Coba lagi sebentar lagi.");
                return;
            }

            const dataToSave = {
                title1: document.getElementById('inputTitle1').value,
                title2: document.getElementById('inputTitle2').value,
                img1: document.getElementById('inputImg1').value,
                img2: document.getElementById('inputImg2').value,
                message: document.getElementById('inputMessage').value,
                sender: document.getElementById('inputSender').value,
                createdAt: new Date().toISOString()
            };

            // Tampilkan Loading di tombol
            const saveBtn = document.getElementById('saveActionBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="ph ph-spinner animate-spin"></i> Menyimpan...';
            saveBtn.disabled = true;

            try {
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'cards');
                const docRef = await addDoc(colRef, dataToSave);
                
                // Berhasil Simpan
                const newUrl = `${window.location.origin}${window.location.pathname}?id=${docRef.id}`;
                
                // Update UI State
                updateUI(dataToSave);
                toggleEdit(); // Kembali ke view mode
                
                // Tampilkan Modal Share
                document.getElementById('shareUrlInput').value = newUrl;
                document.getElementById('shareModal').classList.remove('hidden');
                
                // Rayakan
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });

            } catch (error) {
                console.error("Error saving:", error);
                alert("Gagal menyimpan pesan. Coba lagi.");
            } finally {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        };

        function updateUI(data) {
            document.getElementById('titlePart1').textContent = data.title1;
            document.getElementById('titlePart2').textContent = data.title2;
            document.getElementById('img1Display').src = data.img1;
            document.getElementById('img2Display').src = data.img2;
            document.getElementById('messageText').innerText = data.message;
            document.getElementById('senderName').textContent = 'Sincerely, ' + data.sender;
        }

    </script>

    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #fff5f5;
            background-image: radial-gradient(#cbd5e1 1.5px, transparent 1.5px);
            background-size: 24px 24px;
            min-height: 100vh;
            color: #1a1a1a;
            overflow-x: hidden;
            position: relative;
        }

        /* Gradien Blob Background */
        .blob-bg {
            position: fixed;
            border-radius: 50%;
            filter: blur(60px);
            z-index: -1;
            opacity: 0.6;
            animation: breathe 8s infinite ease-in-out;
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        h1, h2, .title-font {
            font-family: 'Syne', sans-serif;
        }

        /* Kartu Utama - Bubble Pop Style */
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 3px solid #1a1a1a;
            border-radius: 40px;
            box-shadow: 8px 8px 0px #1a1a1a;
            position: relative;
            transition: transform 0.3s;
        }

        .framed-img {
            border-radius: 24px;
            border: 3px solid #1a1a1a;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.15);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: white;
            object-fit: cover;
        }
        .framed-img:hover {
            transform: scale(1.05) rotate(2deg);
            box-shadow: 6px 6px 0px rgba(0,0,0,0.2);
            z-index: 20;
        }

        .edit-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            background: #f8fafc;
            transition: all 0.2s;
            font-size: 0.95rem;
            font-family: 'Outfit', sans-serif;
        }
        .edit-input:focus {
            background-color: #fff;
            border-color: #1a1a1a;
            box-shadow: 0 0 0 4px rgba(0,0,0,0.05);
            outline: none;
        }

        .label-text {
            font-size: 0.8rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 0.5rem;
            margin-left: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .hidden { display: none !important; }
        
        .highlight {
            position: relative;
            z-index: 1;
        }
        .highlight::after {
            content: '';
            position: absolute;
            bottom: 5px;
            left: -5px;
            right: -5px;
            height: 25px;
            background: #ffbd7b;
            border-radius: 20px;
            z-index: -1;
            transform: rotate(-2deg);
            opacity: 0.6;
        }

        .btn-bubbly {
            border: 2px solid #1a1a1a;
            box-shadow: 4px 4px 0px #1a1a1a;
            border-radius: 9999px;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
        }
        .btn-bubbly:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #1a1a1a;
        }
        .btn-bubbly:hover {
            transform: translate(-1px, -1px);
            box-shadow: 5px 5px 0px #1a1a1a;
        }
        .btn-bubbly:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
            box-shadow: 4px 4px 0px #1a1a1a;
        }

        .pill-badge {
            border: 2px solid #1a1a1a;
            border-radius: 9999px;
            padding: 0.5rem 1.2rem;
            background: white;
            box-shadow: 3px 3px 0px rgba(0,0,0,0.1);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(5px);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-6 relative overflow-x-hidden">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="modal-overlay hidden">
        <div class="flex flex-col items-center">
            <i class="ph ph-spinner animate-spin text-4xl mb-2 text-pink-500"></i>
            <span class="font-bold text-gray-600">Memuat Pesan Spesial...</span>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="shareModal" class="modal-overlay hidden">
        <div class="bg-white border-4 border-black rounded-[30px] p-6 max-w-sm w-full shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] text-center m-4">
            <div class="mb-4 bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto border-2 border-black">
                <i class="ph-fill ph-check text-3xl text-green-600"></i>
            </div>
            <h3 class="font-syne font-bold text-2xl mb-2">Link Siap! ðŸŽ‰</h3>
            <p class="text-sm text-gray-600 mb-4">Pesanmu sudah disimpan. Kirim link ini ke temanmu ya!</p>
            
            <div class="flex gap-2 mb-4">
                <input type="text" id="shareUrlInput" readonly class="edit-input text-xs font-mono !py-2" value="Loading...">
                <button onclick="copyLink()" class="btn-bubbly bg-yellow-300 px-3 hover:bg-yellow-400">
                    <i class="ph-bold ph-copy"></i>
                </button>
            </div>
            
            <button onclick="document.getElementById('shareModal').classList.add('hidden')" class="btn-bubbly bg-black text-white px-6 py-2 w-full">
                Oke, Mengerti
            </button>
        </div>
    </div>

    <!-- Background Blobs -->
    <div class="blob-bg w-80 h-80 top-10 left-10 bg-pink-300 mix-blend-multiply"></div>
    <div class="blob-bg w-96 h-96 bottom-10 right-10 bg-blue-200 mix-blend-multiply animation-delay-2000"></div>
    <div class="blob-bg w-64 h-64 top-1/2 left-1/3 bg-yellow-200 mix-blend-multiply blur-xl"></div>

    <div class="max-w-md w-full relative z-10 animate-[fadeIn_0.8s_ease-out]">
        
        <!-- Tombol Edit (Hanya muncul jika bukan mode view link teman) -->
        <div id="editBtnContainer" class="absolute top-0 right-0 z-30 transform translate-x-2 -translate-y-2">
            <button id="editBtn" onclick="toggleEdit()" class="btn-bubbly flex items-center gap-2 bg-white text-black font-bold py-2 px-5 text-sm group">
                <i class="ph-bold ph-pencil-simple text-lg"></i>
                <span id="btnText">Buat Baru</span>
            </button>
        </div>

        <!-- Dekorasi Floating -->
        <i class="ph-fill ph-star-four text-4xl absolute -top-8 left-4 text-yellow-400 drop-shadow-sm float z-0"></i>
        <i class="ph-fill ph-heart text-3xl absolute top-24 -right-4 text-pink-400 drop-shadow-sm float-reverse z-0"></i>
        <i class="ph-bold ph-sparkle text-3xl absolute bottom-0 -left-6 text-blue-400 float-fast z-0"></i>

        <!-- Header -->
        <div class="text-center mb-10 relative">
            <div class="inline-block pill-badge mb-4 transform rotate-[-3deg] bg-yellow-100">
                <span class="text-xs font-bold tracking-wider uppercase text-yellow-800">âœ¨ Special Delivery</span>
            </div>
            <h1 class="text-6xl font-extrabold text-gray-900 tracking-tight leading-[0.9]">
                <span id="titlePart1" class="highlight">Little</span> <br>
                <span id="titlePart2" class="text-transparent bg-clip-text bg-gradient-to-br from-pink-500 to-violet-600">Things.</span>
            </h1>
        </div>

        <!-- Kartu Utama -->
        <div class="glass-card p-6 md:p-8 text-center space-y-8">
            
            <!-- VIEW MODE -->
            <div id="viewMode">
                <div class="absolute -top-4 -left-4 bg-black text-white w-16 h-16 rounded-full flex items-center justify-center border-2 border-white shadow-lg transform -rotate-12 z-30">
                    <span class="text-[10px] font-bold uppercase text-center leading-tight">For<br>You!</span>
                </div>

                <div class="grid grid-cols-2 gap-4 relative mb-8 mt-4">
                    <div class="relative group transform rotate-[-2deg]">
                        <img id="img1Display" src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExM3R4cW15cnI4Z3I4Z3I4Z3I4Z3I4Z3I4Z3I4Z3I4Z3I4ZSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/3o6fJcIMvb1vt1c5US/giphy.gif" 
                             class="framed-img w-full h-40" alt="Momen 1">
                    </div>
                    <div class="relative group transform rotate-[2deg] mt-6">
                        <img id="img2Display" src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExM3R4cW15cnI4Z3I4Z3I4Z3I4Z3I4Z3I4Z3I4Z3I4Z3I4ZSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/l2JhL1AzTxORUTDlC/giphy.gif" 
                             class="framed-img w-full h-40" alt="Momen 2">
                    </div>
                    
                    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-20 bg-white p-3 border-2 border-black rounded-full shadow-md">
                        <i class="ph-fill ph-heart text-pink-500 text-xl block hover:scale-110 transition-transform"></i>
                    </div>
                </div>

                <div class="text-left relative pt-2">
                    <p id="messageText" class="text-gray-700 text-lg font-medium leading-relaxed tracking-tight">
                        Hai! Cuma mau bilang makasih udah jadi bagian dari cerita aku. Tahun ini emang ga selalu mulus, tapi karena ada kalian, semuanya jadi lebih berwarna. Semoga kedepannya kita tetep bareng-bareng, makin bahagia, dan semua goals kita kecapai. Sayang kalian banyak-banyak!
                    </p>
                    
                    <div class="mt-8 flex justify-end">
                        <div class="relative group cursor-default">
                             <div class="absolute inset-0 bg-black rounded-full transform translate-x-1 translate-y-1 transition-transform group-hover:translate-x-1.5 group-hover:translate-y-1.5"></div>
                             <span id="senderName" class="relative block bg-white border-2 border-black px-5 py-2 rounded-full text-sm font-bold text-black uppercase tracking-wide">Sincerely, [Nama Kamu]</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EDIT MODE FORM -->
            <div id="editMode" class="hidden text-left space-y-5">
                <div class="bg-blue-50 text-blue-800 p-4 rounded-3xl text-sm font-bold flex items-center gap-3 border border-blue-100">
                    <div class="bg-blue-200 p-1.5 rounded-full text-blue-700"><i class="ph-fill ph-gear"></i></div>
                    Mode Pembuatan Pesan
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="label-text">Line 1</label>
                        <input type="text" id="inputTitle1" class="edit-input font-bold" placeholder="Little">
                    </div>
                    <div>
                        <label class="label-text">Line 2</label>
                        <input type="text" id="inputTitle2" class="edit-input font-bold text-pink-500" placeholder="Things.">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="label-text">Foto Kiri (Link)</label>
                        <input type="text" id="inputImg1" class="edit-input text-xs" placeholder="https://...">
                    </div>
                    <div>
                        <label class="label-text">Foto Kanan (Link)</label>
                        <input type="text" id="inputImg2" class="edit-input text-xs" placeholder="https://...">
                    </div>
                </div>

                <div>
                    <label class="label-text">Pesan Kamu</label>
                    <textarea id="inputMessage" rows="5" class="edit-input text-base leading-relaxed"></textarea>
                </div>
                <div>
                    <label class="label-text">Nama Pengirim</label>
                    <input type="text" id="inputSender" class="edit-input font-bold uppercase">
                </div>

                <!-- Tombol Simpan -->
                <button id="saveActionBtn" onclick="saveCardToCloud()" class="btn-bubbly bg-black text-white w-full py-3 font-bold text-lg hover:bg-gray-800">
                    Simpan & Buat Link âœ¨
                </button>
            </div>

        </div>

        <p class="text-center text-gray-400 text-[11px] mt-8 font-bold uppercase tracking-widest opacity-70">
            Made for Memories âœ¨
        </p>
    </div>

    <script>
        let isEditing = false;
        const editBtn = document.getElementById('editBtn');
        const btnText = document.getElementById('btnText');
        const btnIcon = editBtn.querySelector('i');

        // Elements
        const viewMode = document.getElementById('viewMode');
        const editMode = document.getElementById('editMode');
        const titlePart1 = document.getElementById('titlePart1');
        const titlePart2 = document.getElementById('titlePart2');
        const img1Display = document.getElementById('img1Display');
        const img2Display = document.getElementById('img2Display');
        const messageText = document.getElementById('messageText');
        const senderName = document.getElementById('senderName');

        // Inputs
        const inputTitle1 = document.getElementById('inputTitle1');
        const inputTitle2 = document.getElementById('inputTitle2');
        const inputImg1 = document.getElementById('inputImg1');
        const inputImg2 = document.getElementById('inputImg2');
        const inputMessage = document.getElementById('inputMessage');
        const inputSender = document.getElementById('inputSender');

        function toggleEdit() {
            isEditing = !isEditing;

            if (isEditing) {
                // Populate Inputs from View
                inputTitle1.value = titlePart1.textContent;
                inputTitle2.value = titlePart2.textContent;
                inputImg1.value = img1Display.src;
                inputImg2.value = img2Display.src;
                inputMessage.value = messageText.innerText;
                inputSender.value = senderName.textContent.replace('Sincerely, ', '');

                // Show Edit Mode
                viewMode.classList.add('hidden');
                editMode.classList.remove('hidden');
                
                // Update Button to "Cancel" style
                btnText.textContent = 'Batal';
                btnIcon.classList.replace('ph-pencil-simple', 'ph-x');
                editBtn.classList.add('bg-red-100', 'text-red-600');
                editBtn.classList.remove('bg-white', 'text-black');

            } else {
                // Cancel changes / Back to View
                viewMode.classList.remove('hidden');
                editMode.classList.add('hidden');
                
                // Update Button Back
                btnText.textContent = 'Buat Baru';
                btnIcon.classList.replace('ph-x', 'ph-pencil-simple');
                editBtn.classList.remove('bg-red-100', 'text-red-600');
                editBtn.classList.add('bg-white', 'text-black');
            }
        }

        function copyLink() {
            const copyText = document.getElementById("shareUrlInput");
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            document.execCommand("copy");
            alert("Link tersalin! Kirim ke temanmu sekarang.");
        }

        window.onload = () => {
            // Confetti awal
            var duration = 2000;
            var end = Date.now() + duration;
            (function frame() {
                confetti({ particleCount: 2, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#f472b6', '#60a5fa', '#facc15'] });
                confetti({ particleCount: 2, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#f472b6', '#60a5fa', '#facc15'] });
                if (Date.now() < end) { requestAnimationFrame(frame); }
            }());
        };
    </script>
</body>
</html>
